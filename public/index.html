<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>實價登錄 CSV 瀏覽器</title>

    <!-- ===== Light, colorful theme (白色繽紛色系) ===== -->
    <style>
      :root{
        --bg: #f7f8fc;
        --card:#ffffff;
        --muted:#6b7280;
        --text:#111827;
        --accent:#6ea8fe;   /* 柔和藍 */
        --accent2:#67e8f9;  /* 清新藍綠 */
        --border:#e5e7eb;
        --thead:#f3f6ff;
        --zebra:#fafbff;
        --pill:#eef2ff;
        --sticky:#ffffff;

        /* 多欄 KV 表寬度（可自行微調） */
        --kv-label-w: 120px;
        --kv-value-w: 220px;
      }
      *{ box-sizing:border-box; }
      body{
        margin:0;
        background: radial-gradient(1200px 600px at 20% -10%, #e9f0ff, #f7f8fc);
        color:var(--text);
        font-family: ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif;
      }
      header{
        padding:22px;
        border-bottom:1px solid var(--border);
        background: linear-gradient(180deg, #ffffffcc, #ffffffa0);
        position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(6px);
      }
      .container{ max-width:1600px; margin:0 auto; padding:16px; }
      h2{ margin:0 0 4px; font-weight:700; letter-spacing:.3px; }
      .muted{ color:var(--muted); }

      .card{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:16px;
        padding:16px; margin:14px 0;
        box-shadow:0 6px 18px rgba(44,63,88,.06);
      }

      .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
      label{ font-size:13px; color:var(--muted); margin-right:6px; }

      select, input[type=text]{
        background:#fff;
        border:1px solid var(--border);
        color:var(--text);
        padding:8px 10px; border-radius:10px; outline:none;
        transition: box-shadow .15s, border-color .15s;
      }
      select:focus, input[type=text]:focus{
        border-color:#bfd3ff;
        box-shadow:0 0 0 4px rgba(110,168,254,.25);
      }

      button{
        padding:8px 12px; border-radius:10px;
        border:1px solid var(--border);
        background: linear-gradient(180deg, #ffffff, #f1f5ff);
        color:var(--text); cursor:pointer; transition:transform .2s, box-shadow .2s;
      }
      button:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.08); }
      .btn-accent{
        border-color:#b9d1ff;
        background: linear-gradient(180deg, #e7f0ff, #dce9ff);
      }

      #dropzone{
        border:2px dashed #c9d8ff; border-radius:16px; padding:22px; text-align:center; color:var(--muted);
        background:#fff;
      }
      #dropzone.drag{ background:linear-gradient(180deg,#f4f8ff,#ffffff); border-color:var(--accent); color:var(--text); }

      progress{ width:240px; height:12px; vertical-align:middle; }

      table{ border-collapse:separate; border-spacing:0; width:100%; font-size:14px; table-layout:fixed; }
      th, td{ padding:8px 10px; border-bottom:1px solid var(--border); vertical-align:top; }
      thead th{ position:sticky; top:0; background:var(--thead); z-index:5; }
      tbody tr:nth-child(even){ background:var(--zebra); }

      .pagination{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px; }

      .detail{ background:#f9fbff; border:1px solid var(--border); padding:12px; border-radius:12px; margin-top:8px; }
      .pill{ padding:2px 8px; border-radius:999px; background:var(--pill); border:1px solid #dbe4ff; color:#3446a1; }
      .nowrap{ white-space:nowrap; }
      .hidden{ display:none; }

      .tableWrap{ overflow:auto; max-width:100%; }
      th .thwrap{
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.2;
      }
      td .cell{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      thead th{ z-index:4; }
      th.sticky-left, td.sticky-left{ position:sticky; left:0; background:var(--sticky); z-index:5; }
      th.sticky-right, td.sticky-right{ position:sticky; right:0; background:var(--sticky); z-index:5; }

      #toast{
        position:fixed; right:16px; bottom:16px; background:#ffffff;
        border:1px solid var(--border); color:#1f2a44; padding:10px 12px; border-radius:10px;
        box-shadow:0 8px 24px rgba(0,0,0,.1); max-width:60ch; opacity:.98; display:none
      }

      /* ===== Modal (查看→彈窗) ===== */
      #modalBackdrop{
        position:fixed; inset:0; background:rgba(15,23,42,.35);
        display:none; z-index:50;
      }
      #modal{
        position:fixed; inset:0; display:none; z-index:60;
        align-items:flex-start; justify-content:center; padding:32px 16px; overflow:auto;
      }
      .modal-box{
        background:#fff; color:var(--text); border:1px solid var(--border); border-radius:16px;
        width:min(1100px, calc(100% - 16px)); box-shadow:0 20px 50px rgba(0,0,0,.18);
        animation: pop .15s ease-out; margin-top:4vh;overflow: hidden;  
      }
      .modal-hd{
        display:flex; align-items:center; justify-content:space-between; padding:14px 16px;
        border-bottom:1px solid var(--border); background:linear-gradient(180deg,#ffffff,#f7faff);
        position:sticky; top:0;
      }
      .modal-tt{ font-weight:700; }
      .modal-bd{ padding:12px 16px; }
      .icon-btn{ border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:6px 9px; }
      .icon-btn:hover{ box-shadow:0 3px 10px rgba(0,0,0,.08); }

      @keyframes pop { from{ transform:translateY(10px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

      /* ===== 多欄 KV 表（長字會換行、不溢出） ===== */
      .kv-table{
        width:100%;
        border-collapse:collapse;
        table-layout:fixed;
        margin-bottom:10px;
        border-radius: 0;
      }
      .kv-table th.kv-label{
        width: var(--kv-label-w);
        text-align:right;
        padding:6px 8px;
        background:#f3f6ff;
        border:1px solid var(--border);
        font-weight:600;
        vertical-align:top;
        white-space:normal;
        word-break:break-all;
        overflow-wrap:anywhere;
      }
      .kv-table td.kv-value{
        width: var(--kv-value-w);
        padding:6px 8px;
        border:1px solid var(--border);
        white-space:normal;
        word-break:break-all;
        overflow-wrap:anywhere;
      }

      @media (max-width: 767.98px){
        :root { --kv-label-w: 110px; --kv-value-w: 1fr; }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="container">
        <h2>實價登錄 CSV 瀏覽器</h2>
        <div id="period" class="muted"></div>
        <span style="float: right;">請至 <a target="_blank" href="https://plvr.land.moi.gov.tw/DownloadOpenData">內政部不動產成交案件實際資訊資料供應系統</a> 下載CSV壓縮檔資訊</span>
      </div>
    </header>

    <div class="container">
      <!-- Upload first -->
      <div class="card" id="uploadCard">
        <div id="dropzone">
          把 ZIP 拖曳到這裡，或
          <input type="file" id="zipfile" accept=".zip">
          <button class="btn-accent" id="uploadBtn">上傳 ZIP</button>
          <progress id="upProgress" max="100" value="0" class="hidden"></progress>
          <span id="uploadStatus" class="muted"></span>
        </div>
      </div>

      <!-- Browser after upload -->
      <div id="browser" class="hidden">
        <div class="card">
          <div class="row">
            <label>縣市</label>
            <select id="city"></select>
            <label>鄉鎮市區</label>
            <select id="district"><option value="">全部</option></select>
            <label>類型</label>
            <select id="type">
              <option value="a">不動產買賣</option>
              <option value="b">預售屋買賣</option>
              <option value="c">不動產租賃</option>
            </select>
            <label>每頁</label>
            <select id="limit"><option>20</option><option>50</option><option>100</option></select>
            <input type="text" id="keyword" placeholder="關鍵字（地址/備註）">
            <button id="go" class="btn-accent">查詢</button>

            <!-- ===== 新增：重新上傳 ZIP ===== -->
            <button id="reuploadTrigger" class="btn-accent" title="重新上傳 ZIP">重新上傳 ZIP</button>
            <input type="file" id="zipReupload" accept=".zip" class="hidden">
            <progress id="reupProgress" max="100" value="0" class="hidden"></progress>
            <span id="reupStatus" class="muted"></span>
            <!-- ============================== -->
          </div>
        </div>

        <div class="card">
          <div class="tableWrap"><div id="table"></div></div>
          <div class="pagination">
            <button id="prev">上一頁</button>
            <span id="pageInfo" class="muted"></span>
            <button id="next">下一頁</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Modal DOM ===== -->
    <div id="modalBackdrop" aria-hidden="true"></div>
    <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-box">
        <div class="modal-hd">
          <div class="modal-tt" id="modalTitle">詳細資料</div>
          <div style="display:flex; gap:8px;">
            <button id="modalClose" class="icon-btn" title="關閉">✕</button>
          </div>
        </div>
        <div class="modal-bd" id="modalBody">
          <!-- 動態塞入 -->
        </div>
      </div>
    </div>

    <script>
      let CURRENT = { page: 1, total: 0 };

      // ---------- helpers ----------
      async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }
      function el(tag, attrs = {}, ...children) {
        const e = document.createElement(tag);
        for (const [k,v] of Object.entries(attrs)) {
          if (k === 'class') e.className = v;
          else if (k === 'html') e.innerHTML = v;
          else e.setAttribute(k, v);
        }
        for (const c of children) {
          if (typeof c === 'string') e.appendChild(document.createTextNode(c));
          else if (c) e.appendChild(c);
        }
        return e;
      }
      function show(id, on) { document.getElementById(id).classList.toggle('hidden', !on); }

      // ---------- upload (with progress) ----------
      function uploadZipWithProgress(file, opts = {}) {
        const status = document.getElementById(opts.statusId || 'uploadStatus');
        const bar = document.getElementById(opts.progressId || 'upProgress');
        status.textContent = ''; bar.classList.remove('hidden'); bar.value = 0;
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/upload');
          xhr.setRequestHeader('X-Filename', file.name || 'upload.zip');
          xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) { bar.value = Math.round(e.loaded / e.total * 100); }
          };
          xhr.onload = () => {
            bar.classList.add('hidden');
            if (xhr.status >= 200 && xhr.status < 300) {
              try { resolve(JSON.parse(xhr.responseText)); }
              catch { reject(new Error('回應格式錯誤')); }
            } else {
              reject(new Error('上傳失敗：' + xhr.status));
            }
          };
          xhr.onerror = () => { bar.classList.add('hidden'); reject(new Error('網路錯誤')); };
          xhr.send(file); // raw binary
        });
      }

      // ---------- manifest & districts ----------
      async function loadManifest() {
        const data = await fetchJSON('/api/manifest');
        document.getElementById('period').textContent = data.periodFriendly || data.period || '';

        // 有資料就把上傳 UI 收起
        if (data && data.files && Object.keys(data.files).length) {
          show('uploadCard', false);
          show('browser', true);
        }

        const citySel = document.getElementById('city');
        citySel.innerHTML = '';
        const entries = Object.values(data.cities || []);
        entries.sort((a,b)=>a.code.localeCompare(b.code));
        for (const c of entries) citySel.appendChild(el('option', { value: c.code }, c.name || c.code));
        await loadDistricts();
      }

      async function loadDistricts() {
        const res = await fetchJSON(`/api/districts?city=${document.getElementById('city').value}&type=${document.getElementById('type').value}`);
        const sel = document.getElementById('district');
        const keep = sel.value;
        sel.innerHTML = ''; sel.appendChild(el('option', { value: '' }, '全部'));
        for (const d of res.districts) sel.appendChild(el('option', { value: d }, d));
        if ([...sel.options].some(o=>o.value===keep)) sel.value = keep;
      }

      // ---------- table ----------
      function measureTextWidth(text, font='14px ui-sans-serif,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans TC,Helvetica Neue,Arial'){ const c=document.createElement('canvas'); const ctx=c.getContext('2d'); ctx.font=font; return ctx.measureText(text||'').width; }
      function computeColWidths(header, rows) {
        const samples = rows.slice(0, 80);
        const specialWide = new Set(['土地位置建物門牌','備註','建案名稱']);
        return header.map((h, i) => {
          let max = measureTextWidth(String(h));
          for (const r of samples) {
            const w = measureTextWidth(String(r[i]||''));
            if (w > max) max = w;
          }
          let minW = 90, maxW = 240;
          if (specialWide.has(h)) { minW = 180; maxW = 380; }
          if (['鄉鎮市區','交易年月日','建築完成年月','移轉層次'].includes(h)) { minW = 120; maxW = 220; }
          const numeric = samples.length && samples.every(r => /^\s*[\d.,-]*\s*$/.test(String(r[i]||'')));
          if (numeric) { minW = 80; maxW = Math.min(maxW, 120); }
          const padding = 28;
          const w = Math.min(maxW, Math.max(minW, max + padding));
          return Math.round(w);
        });
      }
      function renderTable(header, rows) {
        const container = document.getElementById('table');
        const table = el('table');
        const widths = computeColWidths(header, rows);
        const colgroup = el('colgroup');
        widths.forEach(w => colgroup.appendChild(el('col', { style: `width:${w}px` })));
        colgroup.appendChild(el('col', { style: 'width:100px' })); // 操作欄
        table.appendChild(colgroup);

        const thead = el('thead'); const trh = el('tr');
        header.forEach((h, idx) => {
          const th = el('th', {}, '');
          const inner = el('div', { class: 'thwrap', title: h }, h);
          th.appendChild(inner);
          if (idx === 0) th.classList.add('sticky-left');
          trh.appendChild(th);
        });
        const thOp = el('th', { class: 'sticky-right' }, '操作');
        trh.appendChild(thOp);
        thead.appendChild(trh); table.appendChild(thead);

        const tbody = el('tbody');
        for (const row of rows) {
          const tr = el('tr');
          row.forEach((cell, idx) => {
            const td = el('td', {}, '');
            const div = el('div', { class: 'cell', title: String(cell||'') }, String(cell||''));
            td.appendChild(div);
            if (idx === 0) td.classList.add('sticky-left');
            tr.appendChild(td);
          });
          const idx = header.indexOf('編號'); const id = idx >= 0 ? row[idx] : '';
          const btn = el('button', { 'data-id': id, class: 'nowrap' }, '查看');
          btn.onclick = () => loadDetail(id);   // 彈窗
          const op = el('td', { class: 'sticky-right' }, btn);
          tr.appendChild(op);
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        container.innerHTML = ''; container.appendChild(table);
      }

      // ---------- queries ----------
      async function query(page = 1) {
        const city = document.getElementById('city').value;
        const type = document.getElementById('type').value;
        const limit = document.getElementById('limit').value;
        const keyword = encodeURIComponent(document.getElementById('keyword').value.trim());
        const district = encodeURIComponent(document.getElementById('district').value || '');
        const data = await fetchJSON(`/api/list?city=${city}&type=${type}&district=${district}&page=${page}&limit=${limit}&keyword=${keyword}`);
        CURRENT = { page: data.page, total: data.total, limit: data.limit };
        renderTable(data.header, data.rows);
        document.getElementById('pageInfo').textContent = `第 ${data.page} / ${Math.max(1, Math.ceil(data.total / data.limit))} 頁（共 ${data.total} 筆）`;
      }

      // ===== Modal helpers =====
      const modal = document.getElementById('modal');
      const modalBody = document.getElementById('modalBody');
      const modalBackdrop = document.getElementById('modalBackdrop');
      const modalCloseBtn = document.getElementById('modalClose');

      function openModal(){
        modalBackdrop.style.display = 'block';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
      function closeModal(){
        modal.style.display = 'none';
        modalBackdrop.style.display = 'none';
        document.body.style.overflow = '';
        modalBody.innerHTML = '';
      }
      modalCloseBtn.addEventListener('click', closeModal);
      modalBackdrop.addEventListener('click', closeModal);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

      // 依視窗寬度決定每列擺幾組 label+value
      function getKVColsPerRow(){
        const w = window.innerWidth;
        if (w >= 1200) return 3;   // 寬：3 組
        if (w >= 768)  return 2;   // 中：2 組
        return 1;                  // 窄：1 組
      }

      // ---------- detail（彈窗 + 多欄 KV） ----------
      async function loadDetail(id) {
        const city = document.getElementById('city').value;
        const type = document.getElementById('type').value;
        const data = await fetchJSON(`/api/detail?city=${city}&type=${type}&id=${encodeURIComponent(id)}`);

        const wrap = el('div', {});
        wrap.appendChild(renderKV(data.header, data.row, getKVColsPerRow()));

        if (data.details?.land?.length) {
          wrap.appendChild(el('h4', {}, '土地明細'));
          for (const r of data.details.land) wrap.appendChild(renderKV(data.details.landHeader, r, getKVColsPerRow()));
        }
        if (data.details?.build?.length) {
          wrap.appendChild(el('h4', {}, '建物明細'));
          for (const r of data.details.build) wrap.appendChild(renderKV(data.details.buildHeader, r, getKVColsPerRow()));
        }
        if (data.details?.park?.length) {
          wrap.appendChild(el('h4', {}, '車位明細'));
          for (const r of data.details.park) wrap.appendChild(renderKV(data.details.parkHeader, r, getKVColsPerRow()));
        }

        modalBody.innerHTML = '';
        modalBody.appendChild(wrap);
        openModal();
      }

      // 多欄 KV：一列可擺 N 組（label+value）
      function renderKV(header, row, colsPerRow = 3) {
        const tbl = el('table', { class: 'kv-table' });
        const tb = el('tbody');

        for (let i = 0; i < header.length; i += colsPerRow) {
          const tr = el('tr');
          for (let j = 0; j < colsPerRow; j++) {
            const idx = i + j;
            if (idx < header.length) {
              tr.appendChild(el('th', { class: 'kv-label', title: header[idx] }, header[idx]));
              const val = row[idx] ?? '';
              tr.appendChild(el('td', { class: 'kv-value', title: String(val) }, String(val)));
            } else {
              tr.appendChild(el('th', { class: 'kv-label' }, ''));
              tr.appendChild(el('td', { class: 'kv-value' }, ''));
            }
          }
          tb.appendChild(tr);
        }

        tbl.appendChild(tb);
        return tbl;
      }

      // ---------- events ----------
      // 原本的首次上傳
      document.getElementById('uploadBtn').onclick = async () => {
        const f = document.getElementById('zipfile').files[0];
        if (!f) return alert('請先選擇 ZIP 檔');
        try {
          const r = await uploadZipWithProgress(f);
          document.getElementById('uploadStatus').textContent = '上傳完成';
          const periodText = (r.periodFriendly || r.period || '').trim();
          if (periodText) document.getElementById('period').textContent = periodText;
          await loadManifest();
          show('uploadCard', false);
          show('browser', true);
        } catch (e) {
          document.getElementById('uploadStatus').textContent = '失敗：' + e.message;
        }
      };

      // 新增：重新上傳 ZIP（在查詢列）
      document.getElementById('reuploadTrigger').onclick = () => {
        document.getElementById('zipReupload').click();
      };
      document.getElementById('zipReupload').addEventListener('change', async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        try {
          const r = await uploadZipWithProgress(f, { progressId: 'reupProgress', statusId: 'reupStatus' });
          document.getElementById('reupStatus').textContent = '上傳完成';
          const periodText = (r.periodFriendly || r.period || '').trim();
          if (periodText) document.getElementById('period').textContent = periodText;
          await loadManifest();
          show('uploadCard', false);
          show('browser', true);
          await query(1); // 重新載入列表
        } catch (err) {
          document.getElementById('reupStatus').textContent = '失敗：' + err.message;
        } finally {
          e.target.value = ''; // 清空，方便再次選同一檔
        }
      });

      // 拖放首次上傳
      const dz = document.getElementById('dropzone');
      ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.add('drag'); }));
      ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.remove('drag'); }));
      dz.addEventListener('drop', async (e)=>{
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (f && f.name.toLowerCase().endsWith('.zip')) {
          try {
            const r = await uploadZipWithProgress(f);
            const periodText = (r.periodFriendly || r.period || '').trim();
            if (periodText) document.getElementById('period').textContent = periodText;
            await loadManifest();
            show('uploadCard', false);
            show('browser', true);
          } catch (err) {
            document.getElementById('uploadStatus').textContent = '失敗：' + err.message;
          }
        }
      });

      document.getElementById('city').onchange = async () => { await loadDistricts(); query(1); };
      document.getElementById('type').onchange = async () => { await loadDistricts(); query(1); };
      document.getElementById('district').onchange = () => query(1);
      document.getElementById('go').onclick = () => query(1);
      document.getElementById('prev').onclick = () => { if (CURRENT.page > 1) query(CURRENT.page - 1); };
      document.getElementById('next').onclick = () => {
        const maxPage = Math.max(1, Math.ceil(CURRENT.total / CURRENT.limit));
        if (CURRENT.page < maxPage) query(CURRENT.page + 1);
      };

      // ---------- toast & global error ----------
      function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 5000); }
      window.addEventListener('error', e => { console.error('window error', e); toast('前端錯誤：' + (e.message || e.error)); });
      window.addEventListener('unhandledrejection', e => { console.error('unhandledrejection', e.reason); toast('未處理的錯誤：' + (e.reason?.message || e.reason || '')); });

      // ---------- init ----------
      (async () => {
        try {
          const m = await fetchJSON('/api/manifest');
        if (m && m.files && Object.keys(m.files).length) {
            document.getElementById('period').textContent = m.periodFriendly || m.period || '';
            await loadManifest();
            show('uploadCard', false);
            show('browser', true);
          } else {
            show('browser', false);
            show('uploadCard', true);
          }
        } catch {
          show('browser', false);
          show('uploadCard', true);
        }
      })();
    </script>

    <div id="toast"></div>
  </body>
</html>
