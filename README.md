
# 實價登錄 CSV 瀏覽器

一個以 **Node.js 原生模組** 寫成的單機型工具，用來 **上傳內政部實價登錄 ZIP**，並在瀏覽器中即時 **查詢 / 篩選 / 檢視**。  
支援 **彈窗詳情**、**欄位管理（勾選隱藏 + 拖拉排序）**、**列寬模式（緊湊 / 標準 / 寬鬆）**、**上傳進度條**，以及 **民國 → 西元** 與 **每坪單價（不含車位）** 的即時計算。

> 本工具只在本機跑，不會把資料傳到網路。

---

## ✨ 特色

- **免資料庫、免外部套件**：以 `http` / `fs` / `child_process` 等 Node 內建模組實作。
- **上傳一鍵完成**：拖曳或選檔上傳內政部 ZIP，進度條顯示百分比，解壓後自動載入。
- **動態瀏覽**：選「縣市 → 鄉鎮市區 → 類型（買賣 / 預售 / 租賃）」與關鍵字，支援分頁。
- **彈窗詳情**：主檔 + 土地 / 建物 / 車位明細；右上角資訊卡顯示「西元日期」與「每坪單價（不含車位）」。
- **欄位管理**：可 **勾選隱藏** 與 **拖拉排序**，設定會保存於 `localStorage`。
- **列寬模式**：以 canvas 測量字寬，搭配「緊湊 / 標準 / 寬鬆」三種模式，長字自動省略（hover 顯示）。
- **固定欄**：表頭固定；**操作**欄固定在最左側；第一個資料欄（預設為「鄉鎮市區」）也會固定。

---

## 🖥 系統需求

- Node.js **18+**
- macOS / Windows / Linux 均可（macOS 及 Linux 需有系統 `unzip`；Windows 以 PowerShell `Expand-Archive`）

---

## 🚀 安裝與啟動

```bash
# 1) 安裝 Node 後，在專案根目錄執行
node server.js

# 2) 開瀏覽器
#    http://localhost:3000
```

---

## 📦 上傳資料（ZIP）

1. 進頁面後，先看到 **上傳卡**：把官方 ZIP **拖曳**到虛線框，或按「上傳 ZIP」選檔。
2. 進度條會顯示百分比，解壓完成後自動載入並顯示「瀏覽卡」。  
3. 若 ZIP 內部**只包一層資料夾**，系統會自動「**上移**」其內容到批次根，無需手動調整。

> CLI 測試（非必要）：
```bash
curl -X POST --data-binary @你的檔案.zip   -H "X-Filename: 你的檔案.zip"   http://localhost:3000/upload
```

---

## 🔎 瀏覽與查詢

- 選 **縣市** → **鄉鎮市區**（動態帶入）→ **類型**（a=買賣、b=預售、c=租賃）。
- 可輸入 **關鍵字**（地址 / 備註）搜尋；支援 **分頁大小** 選擇。
- 點「**查看**」以 **彈窗** 顯示主檔 + 明細（土地 / 建物 / 車位）。
- **資訊卡**：自動將民國年日期轉為西元；「每坪單價（不含車位）」依 `單價元平方公尺 × 3.305785` 計算。  
  工具列「**單價小數**」下拉可切換 **0 / 1 / 2 位**（預設 1 位）。

### 欄位管理
- 按「**欄位**」開啟面板：可勾選是否顯示、拖拉調整順序、或「重設」恢復預設。  
- **鎖定欄位**（預設為「鄉鎮市區」）不可隱藏，會顯示「鎖定」徽章。
- 設定保存於 `localStorage`，重整仍有效。

### 列寬模式
- 「**寬度**」可切換「緊湊 / 標準 / 寬鬆」三種模式。  
- 內建欄寬估算器會取表頭與前 80 筆資料來計算「舒適寬度」，地址 / 備註 / 建案名稱等欄有更寬上限；數字欄較窄。

---

## 🗂 檔案結構與命名

- 每個縣市一組檔案，檔名首字為**縣市代碼**：  
  `a` 臺北市、`b` 臺中市、`c` 基隆市、`d` 臺南市、`e` 高雄市、`f` 新北市、`g` 宜蘭縣、`h` 桃園市、`i` 嘉義市、`j` 新竹縣、`k` 苗栗縣、`m` 南投縣、`n` 彰化縣、`o` 新竹市、`p` 雲林縣、`q` 嘉義縣、`t` 屏東縣、`u` 花蓮縣、`v` 臺東縣、`w` 金門縣、`x` 澎湖縣、`z` 連江縣。

- 每縣市依 **型別** 分成 3 類：
  - `*_lvr_land_a.csv`：**不動產買賣**
  - `*_lvr_land_b.csv`：**預售屋買賣**
  - `*_lvr_land_c.csv`：**不動產租賃**

- **明細檔**（依型別存在與否有差）：
  - `*_lvr_land_?_land.csv`：土地明細
  - `*_lvr_land_?_build.csv`：建物明細
  - `*_lvr_land_?_park.csv`：車位明細

- **版本資訊**：`build_time.xml`  
  內含本期資料期間敘述；系統會讀取並顯示於頁面標題下方。

> 每次上傳會建立 `data/batch-<timestamp>/` 目錄，支援同機保留多期資料。

---

## 🔗 資料關聯（主檔 ↔ 明細）

- **關聯鍵**：`編號`
  - 主檔每筆交易 / 租賃都有唯一的 `編號`。
  - 明細檔（`land` / `build` / `park`）以 `編號` 對應主檔，形成 **1 : N** 關係。
- 主檔 `交易筆棟數`（或租賃 `租賃筆棟數`）常包含「土地 x / 建物 y / 車位 z」描述，可用於核對明細數量。

---

## 🧮 重要欄位與計算

- **民國 → 西元**：`YYYYMMDD`（民國） → 年份 `+1911` → `YYYY-MM-DD`；只有年月時，日補 `01`。
- **每坪單價（不含車位）**：`單價元平方公尺 × 3.305785`。  
  > 官方 CSV 的單價通常 **不含車位**；若要「含車位口徑」，需以 `(總價 − 車位總價) ÷ 主建物面積 × 3.305785` 自行計算。

---

## 🔌 API（提供前端使用，若要二開可參考）

- `GET /api/manifest`：回傳目前批次與可用縣市清單（由實際檔案推得）。
- `GET /api/districts?batch=&city=&type=`：回傳鄉鎮市區清單（依檔案即時掃描）。
- `GET /api/list?batch=&city=&type=&district=&page=&limit=&keyword=`：主檔清單（支援分頁與關鍵字）。
- `GET /api/detail?batch=&city=&type=&id=`：主檔 + 三類明細。
- `POST /upload`：上傳 ZIP（二進位串流；header 需含 `X-Filename`）。
- `GET /api/health`：健康檢查。

---

## 🧰 疑難排解（Troubleshooting）

- **上傳沒反應 / 失敗**
  - 看執行 `node server.js` 的終端機輸出（本專案會列出詳細錯誤與解壓 stderr）。
  - mac / Linux 需有系統 `unzip`；Windows 使用 PowerShell `Expand-Archive`。
  - 若 ZIP 中只有單一資料夾，本工具會自動上移；但若目錄層級很多，建議壓成 ZIP 根目錄就放 CSV。

- **查不到縣市或檔案**
  - 確認 ZIP 中是否包含 `*_lvr_land_*.csv` 及 `build_time.xml`。
  - 有時官方會更新欄位名稱或順序，若遇解析異常，請回報 ZIP 範例。

- **表格欄位擠 / 太窄**
  - 可切換「寬度」模式；或用「欄位」面板關掉不必要欄位、或調整順序。
  - 長字會以省略號顯示；滑鼠懸停可看完整內容。

---

## 🔒 注意事項

- 本工具僅作為資料瀏覽與內部分析用途；資料授權與使用規範依內政部實價登錄平台為準。
- 若要發佈到內網或共用機器，請自行加上反向代理 / 基本認證等保護。

---

## 🗺 後續可加功能（Roadmap）

- 兩個批次的**差異比較**（平均單價、成交量、建物年齡分布…）。
- **常用欄 preset**（一鍵只顯示常用欄）。
- 民國 / 西元顯示的切換與格式設定。
- 匯出目前查詢條件的結果為 CSV。

---

## 🏷 版本說明

本 README 對應你目前的功能集（含：上傳進度條、彈窗詳情、民國轉西元與每坪單價、欄位管理、列寬模式、固定欄、城市代碼修正等）。若你更新了前端或後端，建議同步更新本文件。

---

## 👩‍💻 作者與貢獻

若有任何問題或想新增欄位對照 / 統計圖表，請回傳你的 ZIP 範例與想要的介面，我可以直接幫你擴充。

